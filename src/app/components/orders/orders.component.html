<div [style.margin-left.px]="updateMargin()" class="salah bg-body-tertiary">
  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ TOP BAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <div class="d-flex align-items-center justify-content-between mb-2 shadow-sm p-3 bg-white rounded-3">
    <div class="d-flex align-items-center gap-2 flex-wrap">
      <i class="pi pi-table text-primary fs-4"></i>
      <h2 class="fs-4 fw-bold m-0">ÿπÿ±Ÿàÿ∂ ÿßŸÑÿ≥ÿπÿ± / Quotations
        <small class="text-secondary">({{ orders?.length || 0 }})</small>
      </h2>
    </div>
    <div class="d-flex align-items-center gap-2 flex-wrap">
      <!-- global search & refresh -->
      <p-iconfield iconPosition="left" style="background:transparent;border:1px solid #ced4da;border-radius:4px;padding:0 .5rem;min-width:220px;">
        <p-inputicon><i class="pi pi-search text-muted"></i></p-inputicon>
        <input pInputText type="text"
               placeholder="Search‚Ä¶"
               style="border:none;background:transparent;color:#495057"
               (input)="dt1.filterGlobal($event.target.value,'contains')" />
      </p-iconfield>
      <p-button icon="pi pi-filter-slash"
                class="p-button-text text-danger"
                (click)="clear(dt1)"
                tooltip="Clear filters"></p-button>
      <p-button icon="pi pi-refresh"
                class="p-button-text text-primary"
                (click)="loadOrders()"
                tooltip="Reload"></p-button>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ KPI TAGS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <div class="d-flex gap-3 flex-wrap mb-2">
    <p-tag style="color:white"
           [value]="'Avg Price : ' + (averagePrice | currency:'USD')"
           severity="secondary"></p-tag>
  </div>

  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ORDERS TABLE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <div class="card">
    <p-table #dt1
             [value]="orders"
             dataKey="id"
             [rows]="25"
             [rowsPerPageOptions]="[25,50,100]"
             [paginator]="true"
             [responsiveLayout]="'scroll'"
             [loading]="loading"
             [globalFilterFields]="['customer_name','address','order_status']"
             [sortMode]="'multiple'"
             [multiSortMeta]="sortMeta"
             class="p-datatable-sm">
      <ng-template pTemplate="header">
        <tr>
          <th pSortableColumn="id" style="width:5rem">
            ID <p-sortIcon field="id"></p-sortIcon>
          </th>
          <th pSortableColumn="customer_name" style="min-width:14rem">
            Customer <p-sortIcon field="customer_name"></p-sortIcon>
          </th>
          <th pSortableColumn="address" style="min-width:14rem">
            Address <p-sortIcon field="address"></p-sortIcon>
          </th>
          <th pSortableColumn="order_status" style="min-width:9rem">
            Status <p-sortIcon field="order_status"></p-sortIcon>
          </th>
          <th pSortableColumn="order_price" style="min-width:8rem">
            Price <p-sortIcon field="order_price"></p-sortIcon>
          </th>
          <th pSortableColumn="order_cost" style="min-width:8rem">
            Cost <p-sortIcon field="order_cost"></p-sortIcon>
          </th>
          <th pSortableColumn="work_types" style="min-width:8rem">
            Type <p-sortIcon field="work_types"></p-sortIcon>
          </th>
          <th pSortableColumn="created_at" style="min-width:10rem">
            Created <p-sortIcon field="created_at"></p-sortIcon>
          </th>
          <th style="width:4rem; text-align:center">‚ú¶</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-order>
        <tr [ngClass]="rowClass(order)">
          <td>{{ order.id }}</td>
          <td>{{ order.customer_name }}</td>
          <td>{{ order.address }}</td>
          <td>
            <p-tag [value]="order.order_status"
                   [severity]="getSeverity(order.order_status)"></p-tag>
          </td>
          <td>{{ order.order_price | currency:'USD':'symbol' }}</td>
          <td>{{ order.order_cost  | currency:'USD':'symbol' }}</td>
          <td>{{ order.work_types }}</td>
          <td>{{ order.created_at | date:'mediumDate' }}</td>
          <td class="text-center">
            <button type="button"
                    pButton pRipple
                    icon="pi pi-eye"
                    class="p-button-text p-button-sm"
                    (click)="viewOrderDetails(order)"></button>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="footer">
        <tr class="fw-bold">
          <td colspan="4" class="text-end">Totals:</td>
          <td>{{ totalPrice | currency:'USD':'symbol' }}</td>
          <td>{{ totalCost  | currency:'USD':'symbol' }}</td>
          <td colspan="3"></td>
        </tr>
      </ng-template>
    </p-table>
  </div>

  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ STATUS CARDS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <div class="row g-3 mt-3">
    <div class="col-12 col-sm-6 col-md-4" *ngFor="let s of statusSummary">
      <div class="card h-100 shadow-sm">
        <div class="card-body text-center py-3">
          <h6 class="card-title mb-1">{{ s.label }}</h6>
          <p class="mb-0 fw-semibold">{{ s.count }} orders</p>
          <small class="text-muted">{{ s.sum | currency:'USD' }}</small>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ SIDE PANEL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <p-sidebar [(visible)]="isDetailSidebarVisible"
             position="right"
             [dismissible]="false"
             [modal]="true"
             styleClass="shadow-4 sidebar-act"
             (onHide)="closeDetailSidebar()">

    <!-- Header -->
    <ng-template pTemplate="header">
      <div class="d-flex align-items-center gap-2">
        <h3 class="m-0">üìù Order #{{ selectedOrder?.id }}</h3>
        <p-tag [value]="selectedOrder?.order_status"
               [severity]="getSeverity(selectedOrder?.order_status)"></p-tag>
      </div>
    </ng-template>

    <!-- Content -->
    <ng-template pTemplate="content">
      <!-- VIEW MODE -->
      <div *ngIf="selectedOrder && !isEditing" class="d-flex flex-column gap-3">
        <!-- Order Info -->
        <div class="card">
          <div class="card-header bg-light fw-bold">Order Info</div>
          <div class="card-body small">
            <p><strong>Created:</strong> {{ selectedOrder.created_at | date:'medium' }}</p>
            <p><strong>Company:</strong> {{ selectedOrder.company || '‚Äî' }}</p>
            <p><strong>Code:</strong> {{ selectedOrder.code || '‚Äî' }}</p>
            <p><strong>Work Types:</strong> {{ selectedOrder.work_types }}</p>
          </div>
        </div>

        <!-- Customer -->
        <div class="card">
          <div class="card-header bg-light fw-bold">Customer</div>
          <div class="card-body small">
            <p><strong>Name:</strong> {{ selectedOrder.customer_name }}</p>
            <p><strong>Address:</strong> {{ selectedOrder.address }}</p>
          </div>
        </div>

        <!-- Financial -->
        <div class="card">
          <div class="card-header bg-light fw-bold">Financial</div>
          <div class="card-body small">
            <p><strong>Price:</strong> {{ selectedOrder.order_price | currency:'USD' }}</p>
            <p><strong>Cost:</strong> {{ selectedOrder.order_cost | currency:'USD' }}</p>
          </div>
        </div>

        <!-- Measurements -->
        <div class="card">
          <div class="card-header bg-light fw-bold">Measurements</div>
          <div class="card-body p-0">
            <p-table [value]="measurements" styleClass="p-datatable-sm">
              <ng-template pTemplate="header">
                <tr>
                  <th>Type</th>
                  <th>Name</th>
                  <th>Quantity</th>
                  <th>Unit Cost</th>
                  <th>Total Cost</th>
                </tr>
              </ng-template>
              <ng-template pTemplate="body" let-m>
                <tr>
                  <td>{{ m.material_type }}</td>
                  <td>{{ m.material_name }}</td>
                  <td>{{ m.quantity }} {{ m.unit }}</td>
                  <td>{{ m.cost   | currency:'USD':'symbol' }}</td>
                  <td>{{ m.total_cost | currency:'USD':'symbol' }}</td>
                </tr>
              </ng-template>
              <ng-template pTemplate="emptymessage">
                <tr>
                  <td colspan="5" class="text-center text-secondary">
                    No measurements recorded for this order.
                  </td>
                </tr>
              </ng-template>
            </p-table>
          </div>
        </div>
      </div>

      <!-- EDIT MODE -->
      <div *ngIf="isEditing">
        <form [formGroup]="orderForm"
              (ngSubmit)="saveOrder()"
              class="p-fluid small d-flex flex-column gap-3">

          <!-- Customer Info -->
          <div class="card mb-3">
            <div class="card-header bg-light fw-bold">Customer Information</div>
            <div class="card-body">
              <div class="field mb-3">
                <label for="customer_name">Name *</label>
                <input pInputText id="customer_name"
                       formControlName="customer_name" />
              </div>
              <div class="grid">
                <div class="field col-6">
                  <label for="city">City *</label>
                  <p-dropdown id="city"
                              formControlName="city"
                              [options]="cities"
                              optionLabel="label"></p-dropdown>
                </div>
                <div class="field col-6">
                  <label for="address_details">Address *</label>
                  <input pInputText
                         id="address_details"
                         formControlName="address_details" />
                </div>
              </div>
            </div>
          </div>

          <!-- Order Details -->
          <div class="card mb-3">
            <div class="card-header bg-light fw-bold">Order Details</div>
            <div class="card-body">
              <div class="grid">
                <div class="field col-6">
                  <label for="order_status">Status *</label>
                  <p-dropdown id="order_status"
                              formControlName="order_status"
                              [options]="statuses"
                              optionLabel="label"></p-dropdown>
                </div>
                <div class="field col-6">
                  <label for="work_types">Work Types *</label>
                  <input pInputText id="work_types"
                         formControlName="work_types" />
                </div>
                <div class="field col-6">
                  <label for="company">Company</label>
                  <input pInputText id="company"
                         formControlName="company" />
                </div>
                <div class="field col-6">
                  <label for="code">Code *</label>
                  <input pInputText id="code"
                         formControlName="code" />
                </div>
              </div>
            </div>
          </div>

          <!-- Financial -->
          <div class="card mb-3">
            <div class="card-header bg-light fw-bold">Financial</div>
            <div class="card-body">
              <div class="grid">
                <div class="field col-6">
                  <label for="order_price">Price *</label>
                  <p-inputNumber id="order_price"
                                 formControlName="order_price"
                                 mode="currency"
                                 currency="USD"></p-inputNumber>
                </div>
                <div class="field col-6">
                  <label for="order_cost">Cost *</label>
                  <p-inputNumber id="order_cost"
                                 formControlName="order_cost"
                                 mode="currency"
                                 currency="USD"></p-inputNumber>
                </div>
              </div>
            </div>
          </div>

          <!-- Measurements FormArray -->
          <div class="card mb-3">
            <div class="card-header bg-light fw-bold d-flex justify-content-between">
              <span>Measurements</span>
              <button pButton type="button"
                      icon="pi pi-plus"
                      class="p-button-sm"
                      (click)="addMeasurement()"></button>
            </div>
            <div class="card-body" formArrayName="measurements">
              <div *ngFor="let m of measurementFormArray.controls; let i = index"
                   [formGroupName]="i"
                   class="mb-3">
                <div class="grid">
                  <div class="field col-3">
                    <label>Type *</label>
                    <input pInputText formControlName="material_type" />
                  </div>
                  <div class="field col-3">
                    <label>Name *</label>
                    <input pInputText formControlName="material_name" />
                  </div>
                  <div class="field col-2">
                    <label>Unit *</label>
                    <p-dropdown [options]="units"
                                formControlName="unit"
                                optionLabel="label"></p-dropdown>
                  </div>
                  <div class="field col-2">
                    <label>Qty *</label>
                    <p-inputNumber formControlName="quantity" [min]="1"></p-inputNumber>
                  </div>
                  <div class="field col-2">
                    <label>Cost *</label>
                    <p-inputNumber formControlName="cost"
                                   mode="currency"
                                   currency="USD"></p-inputNumber>
                  </div>
                  <div class="col-12 md:col-1 d-flex align-items-end">
                    <button pButton type="button"
                            icon="pi pi-trash"
                            class="p-button-danger p-button-sm"
                            *ngIf="measurementFormArray.length > 1"
                            (click)="removeMeasurement(i)"></button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>

      <!-- ACTION BUTTONS INSIDE CONTENT -->
      <div class="d-flex justify-content-end gap-2 mt-4">
        <ng-container *ngIf="!isEditing">
          <button pButton type="button"
                  icon="pi pi-pencil"
                  label="Edit"
                  class="p-button-primary p-button-sm"
                  (click)="startEditing()"></button>
          <button pButton type="button"
                  icon="pi pi-times"
                  label="Close"
                  class="p-button-secondary p-button-sm"
                  (click)="closeDetailSidebar()"></button>
        </ng-container>
        <ng-container *ngIf="isEditing">
          <button pButton
                  type="button"
                  icon="pi pi-check"
                  label="Save"
                  class="p-button-success p-button-sm"
                  [disabled]="orderForm.invalid"
                  (click)="onSaveEdit()">
          </button>
          <button pButton
                  type="button"
                  icon="pi pi-times"
                  label="Cancel"
                  class="p-button-secondary p-button-sm"
                  (click)="onCancelEdit()">
          </button>
        </ng-container>
        
      </div>
    </ng-template>
  </p-sidebar>
</div>
